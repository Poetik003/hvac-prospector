<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Voice Training & Fine-tuning - ProSpector Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@6.4.0/css/all.min.css">
    
    <style>
        body {
            background: linear-gradient(135deg, #1e293b 0%, #0f172a 50%, #020617 100%);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
        }
        
        .glass-effect {
            background: rgba(15, 23, 42, 0.6);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(148, 163, 184, 0.2);
            box-shadow: 0 8px 32px 0 rgba(0, 0, 0, 0.3);
        }
        
        .gradient-text {
            background: linear-gradient(135deg, #60a5fa 0%, #a855f7 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }
        
        .btn-gradient {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            box-shadow: 0 4px 15px 0 rgba(59, 130, 246, 0.4);
        }
        
        .btn-gradient:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px 0 rgba(59, 130, 246, 0.6);
        }
        
        .voice-card {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        .voice-card:hover {
            transform: translateY(-4px);
            box-shadow: 0 20px 40px 0 rgba(0, 0, 0, 0.4);
        }
        
        .slider-track::-webkit-slider-track {
            background: rgba(148, 163, 184, 0.3);
            border-radius: 5px;
        }
        
        .slider-track::-webkit-slider-thumb {
            background: linear-gradient(135deg, #3b82f6, #a855f7);
            border-radius: 50%;
        }
        
        .pulse-ring {
            animation: pulse-ring 1.5s cubic-bezier(0.215, 0.61, 0.355, 1) infinite;
        }
        
        @keyframes pulse-ring {
            0% {
                transform: scale(.33);
            }
            80%, 100% {
                opacity: 0;
            }
        }
        
        .fade-in {
            animation: fadeIn 0.6s ease-out;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .mobile-friendly {
            -webkit-tap-highlight-color: transparent;
            touch-action: manipulation;
        }
    </style>
</head>
<body class="text-white">
    <!-- Navigation Header -->
    <nav class="glass-effect sticky top-0 z-50 p-4 mb-6">
        <div class="max-w-7xl mx-auto flex items-center justify-between">
            <div class="flex items-center space-x-4">
                <button onclick="goBack()" class="p-2 hover:bg-slate-700/50 rounded-lg transition-colors mobile-friendly">
                    <i class="fas fa-arrow-left text-xl text-slate-400 hover:text-white"></i>
                </button>
                <div>
                    <h1 class="text-xl font-bold gradient-text">AI Voice Training & Fine-tuning</h1>
                    <p class="text-sm text-slate-400">Train natural, authentic conversation models</p>
                </div>
            </div>
            <div class="flex items-center space-x-3">
                <div class="hidden md:flex items-center space-x-2 text-sm text-slate-300">
                    <i class="fas fa-clock text-green-400"></i>
                    <span>Session: <span id="session-timer">00:00</span></span>
                </div>
                <button onclick="saveProgress()" class="btn-gradient px-4 py-2 rounded-lg font-semibold transition-all mobile-friendly">
                    <i class="fas fa-save mr-2"></i>Save Progress
                </button>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 pb-8">
        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            
            <!-- Left Column: Voice Models & Parameters -->
            <div class="lg:col-span-1 space-y-6 fade-in">
                
                <!-- AI Voice Models -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-brain mr-3 text-blue-400"></i>
                        AI Voice Models
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="voice-card glass-effect rounded-xl p-4 border-l-4 border-blue-500 cursor-pointer mobile-friendly" onclick="selectVoiceModel('yeni')">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-white">Yeni Professional</h3>
                                <span class="px-2 py-1 bg-blue-500/20 text-blue-400 text-xs rounded-full">Active</span>
                            </div>
                            <p class="text-sm text-slate-300 mb-3">Warm, confident, Miami Latina accent - Perfect for HVAC sales</p>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); previewVoice('yeni')" class="flex-1 py-2 px-3 bg-blue-600 hover:bg-blue-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-play mr-1"></i>Preview
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); customizeVoice('yeni')" class="py-2 px-3 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="voice-card glass-effect rounded-xl p-4 border-l-4 border-green-500 cursor-pointer mobile-friendly" onclick="selectVoiceModel('danny')">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-white">Danny Authority</h3>
                                <span class="px-2 py-1 bg-yellow-500/20 text-yellow-400 text-xs rounded-full">Training</span>
                            </div>
                            <p class="text-sm text-slate-300 mb-3">Deep, authoritative bilingual voice - Technical expertise focus</p>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); previewVoice('danny')" class="flex-1 py-2 px-3 bg-green-600 hover:bg-green-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-play mr-1"></i>Preview
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); customizeVoice('danny')" class="py-2 px-3 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        
                        <div class="voice-card glass-effect rounded-xl p-4 border-l-4 border-purple-500 cursor-pointer mobile-friendly" onclick="selectVoiceModel('gabi')">
                            <div class="flex items-center justify-between mb-2">
                                <h3 class="font-semibold text-white">Gabi Conversational</h3>
                                <span class="px-2 py-1 bg-purple-500/20 text-purple-400 text-xs rounded-full">Optimizing</span>
                            </div>
                            <p class="text-sm text-slate-300 mb-3">Natural, friendly tone - High conversion rate</p>
                            <div class="flex space-x-2">
                                <button onclick="event.stopPropagation(); previewVoice('gabi')" class="flex-1 py-2 px-3 bg-purple-600 hover:bg-purple-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-play mr-1"></i>Preview
                                </button>
                                <button onclick="event.stopPropagation(); event.preventDefault(); customizeVoice('gabi')" class="py-2 px-3 bg-slate-600 hover:bg-slate-700 text-white text-sm rounded-lg transition-colors mobile-friendly">
                                    <i class="fas fa-cog"></i>
                                </button>
                            </div>
                        </div>
                        
                        <button onclick="createNewModel()" class="w-full py-3 border-2 border-dashed border-slate-600 text-slate-400 hover:border-slate-500 hover:text-slate-300 rounded-xl transition-colors mobile-friendly">
                            <i class="fas fa-plus mr-2"></i>Create New Voice Model
                        </button>
                        
                        <!-- DEBUG: Simple audio test button -->
                        <button onclick="testDirectAudio()" class="w-full py-2 bg-red-600 hover:bg-red-700 text-white text-xs rounded-lg transition-colors mobile-friendly">
                            <i class="fas fa-bug mr-1"></i>Test Direct Audio (Debug)
                        </button>
                    </div>
                </div>

                <!-- Voice Parameters -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-sliders-h mr-3 text-green-400"></i>
                        Voice Parameters
                    </h2>
                    
                    <div class="space-y-6">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3">Speaking Pace</label>
                            <input type="range" id="pace-slider" min="0.5" max="2" step="0.1" value="1" 
                                   class="slider-track w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-slate-400 mt-2">
                                <span>Slower</span>
                                <span id="pace-value" class="font-semibold text-blue-400">1.0x</span>
                                <span>Faster</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3">Voice Pitch</label>
                            <input type="range" id="pitch-slider" min="-200" max="200" step="25" value="0" 
                                   class="slider-track w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-slate-400 mt-2">
                                <span>Lower</span>
                                <span id="pitch-value" class="font-semibold text-green-400">Natural</span>
                                <span>Higher</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3">Emotion Level</label>
                            <input type="range" id="emotion-slider" min="0" max="100" step="10" value="50" 
                                   class="slider-track w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                            <div class="flex justify-between text-xs text-slate-400 mt-2">
                                <span>Neutral</span>
                                <span id="emotion-value" class="font-semibold text-purple-400">50%</span>
                                <span>Enthusiastic</span>
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-3">Conversation Style</label>
                            <select id="style-selector" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-3 mobile-friendly">
                                <option value="professional">Professional & Authoritative</option>
                                <option value="friendly">Friendly & Approachable</option>
                                <option value="consultative">Consultative & Expert</option>
                                <option value="casual">Casual & Conversational</option>
                            </select>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="applyParameters()" class="flex-1 btn-gradient py-3 px-4 rounded-lg font-bold transition-all mobile-friendly">
                                <i class="fas fa-magic mr-2"></i>Apply Settings
                            </button>
                            <button onclick="stopAllAudio()" class="py-3 px-4 bg-red-600 hover:bg-red-700 text-white rounded-lg font-bold transition-all mobile-friendly">
                                <i class="fas fa-stop"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Center Column: Script Editor & Role-Play -->
            <div class="lg:col-span-1 space-y-6 fade-in" style="animation-delay: 0.2s;">
                
                <!-- Script Editor -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-edit mr-3 text-yellow-400"></i>
                        Script Editor
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Training Scenario</label>
                            <select id="scenario-selector" onchange="loadScenario()" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 mobile-friendly">
                                <option value="hvac-winter">HVAC Winter Emergency Call</option>
                                <option value="hvac-maintenance">Preventive Maintenance Pitch</option>
                                <option value="hvac-upgrade">System Upgrade Consultation</option>
                                <option value="objection-price">Price Objection Handling</option>
                                <option value="objection-timing">Timing Objection Response</option>
                                <option value="appointment-setting">Appointment Scheduling</option>
                                <option value="custom">Custom Script</option>
                            </select>
                        </div>
                        
                        <div>
                            <textarea id="script-editor" rows="8" 
                                placeholder="Enter your HVAC training script here...

Example:
Hi [Customer Name], this is Sofia from ProSpector HVAC. I hope I'm catching you at a good time. I'm calling because our records show your heating system is due for its annual maintenance check, and with winter temperatures dropping, I want to make sure your family stays warm and comfortable..."
                                class="w-full bg-slate-700/50 border border-slate-600 text-white rounded-lg px-4 py-3 text-sm resize-none focus:ring-2 focus:ring-blue-500 focus:border-transparent mobile-friendly"></textarea>
                        </div>
                        
                        <div class="flex space-x-3">
                            <button onclick="saveScript()" class="flex-1 py-2 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors mobile-friendly">
                                <i class="fas fa-save mr-2"></i>Save
                            </button>
                            <button onclick="loadTemplate()" class="flex-1 py-2 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors mobile-friendly">
                                <i class="fas fa-file-alt mr-2"></i>Template
                            </button>
                            <button onclick="testScript()" class="flex-1 py-2 px-4 bg-cyan-600 hover:bg-cyan-700 text-white rounded-lg font-semibold transition-colors mobile-friendly">
                                <i class="fas fa-volume-up mr-2"></i>Test
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Role-Play Training -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-users mr-3 text-red-400"></i>
                        AI Role-Play Training
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-slate-300 mb-2">Prospect Personality</label>
                            <select id="prospect-personality" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2 mobile-friendly">
                                <option value="cooperative">Cooperative & Interested</option>
                                <option value="skeptical">Skeptical & Price-Conscious</option>
                                <option value="busy">Busy & Time-Pressured</option>
                                <option value="technical">Technical & Detail-Oriented</option>
                                <option value="difficult">Difficult & Resistant</option>
                            </select>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-3">
                            <button onclick="startRolePlay()" id="roleplay-btn" 
                                class="py-3 px-4 bg-gradient-to-r from-red-600 to-pink-600 hover:from-red-700 hover:to-pink-700 text-white rounded-lg font-bold transition-all mobile-friendly">
                                <i class="fas fa-play mr-2"></i>Start Role-Play
                            </button>
                            <button onclick="pauseRolePlay()" 
                                class="py-3 px-4 bg-yellow-600 hover:bg-yellow-700 text-white rounded-lg font-bold transition-colors mobile-friendly">
                                <i class="fas fa-pause mr-2"></i>Pause
                            </button>
                        </div>
                        
                        <div id="conversation-display" class="bg-slate-900/50 border border-slate-600 rounded-lg p-4 h-40 overflow-y-auto">
                            <p class="text-slate-400 text-sm italic">Role-play conversation will appear here...</p>
                        </div>
                        
                        <div class="flex space-x-2">
                            <button onclick="recordResponse()" class="flex-1 py-2 px-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold mobile-friendly">
                                <i class="fas fa-microphone mr-1"></i>Record
                            </button>
                            <button onclick="analyzePerformance()" class="flex-1 py-2 px-3 bg-purple-600 hover:bg-purple-700 text-white rounded-lg font-semibold mobile-friendly">
                                <i class="fas fa-chart-line mr-1"></i>Analyze
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Column: Analytics & Progress -->
            <div class="lg:col-span-1 space-y-6 fade-in" style="animation-delay: 0.4s;">
                
                <!-- Voice Quality Metrics -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-chart-bar mr-3 text-cyan-400"></i>
                        Voice Quality Metrics
                    </h2>
                    
                    <div class="space-y-4">
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-300">Naturalness Score</span>
                                <span class="text-sm font-bold text-green-400">85%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-green-500 to-emerald-500 h-2 rounded-full" style="width: 85%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-300">Conversation Flow</span>
                                <span class="text-sm font-bold text-blue-400">78%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-blue-500 to-cyan-500 h-2 rounded-full" style="width: 78%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-300">Appointment Potential</span>
                                <span class="text-sm font-bold text-purple-400">92%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-purple-500 to-pink-500 h-2 rounded-full" style="width: 92%"></div>
                            </div>
                        </div>
                        
                        <div>
                            <div class="flex justify-between items-center mb-2">
                                <span class="text-sm text-slate-300">Objection Handling</span>
                                <span class="text-sm font-bold text-yellow-400">71%</span>
                            </div>
                            <div class="w-full bg-slate-700 rounded-full h-2">
                                <div class="bg-gradient-to-r from-yellow-500 to-orange-500 h-2 rounded-full" style="width: 71%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="generateReport()" class="w-full mt-4 py-2 px-4 border border-cyan-500 text-cyan-400 hover:bg-cyan-500/10 rounded-lg transition-colors mobile-friendly">
                        <i class="fas fa-file-chart mr-2"></i>Generate Report
                    </button>
                </div>

                <!-- Real-time Feedback -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-lightbulb mr-3 text-pink-400"></i>
                        AI Feedback & Tips
                    </h2>
                    
                    <div id="feedback-panel" class="space-y-3">
                        <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-check-circle text-green-400 mt-1 flex-shrink-0"></i>
                                <div>
                                    <p class="text-green-400 font-semibold text-sm">Excellent Pace!</p>
                                    <p class="text-slate-300 text-xs">Your speaking pace is perfect for building rapport with prospects.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-500/10 border border-yellow-500/30 rounded-lg p-3">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-lightbulb text-yellow-400 mt-1 flex-shrink-0"></i>
                                <div>
                                    <p class="text-yellow-400 font-semibold text-sm">Tone Suggestion</p>
                                    <p class="text-slate-300 text-xs">Try adding more warmth when mentioning family safety - increases engagement by 23%.</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3">
                            <div class="flex items-start space-x-3">
                                <i class="fas fa-magic text-blue-400 mt-1 flex-shrink-0"></i>
                                <div>
                                    <p class="text-blue-400 font-semibold text-sm">Script Enhancement</p>
                                    <p class="text-slate-300 text-xs">Consider adding "I have just 2 minutes" to reduce time pressure objections.</p>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <button onclick="getMoreTips()" class="w-full mt-4 py-2 px-4 border border-pink-500 text-pink-400 hover:bg-pink-500/10 rounded-lg transition-colors mobile-friendly">
                        <i class="fas fa-plus mr-2"></i>More AI Suggestions
                    </button>
                </div>

                <!-- Training Progress -->
                <div class="glass-effect rounded-2xl p-6">
                    <h2 class="text-xl font-bold mb-4 flex items-center">
                        <i class="fas fa-trophy mr-3 text-orange-400"></i>
                        Training Progress
                    </h2>
                    
                    <div class="space-y-4">
                        <div class="text-center">
                            <div class="text-3xl font-bold gradient-text mb-1">73%</div>
                            <p class="text-sm text-slate-400">Overall Progress</p>
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4 text-center">
                            <div>
                                <div class="text-xl font-bold text-blue-400">12</div>
                                <p class="text-xs text-slate-400">Modules Complete</p>
                            </div>
                            <div>
                                <div class="text-xl font-bold text-purple-400">8.7</div>
                                <p class="text-xs text-slate-400">Training Score</p>
                            </div>
                        </div>
                        
                        <div class="bg-gradient-to-r from-orange-500/10 to-red-500/10 border border-orange-500/30 rounded-lg p-4">
                            <p class="text-orange-400 font-semibold text-sm mb-1">üéØ Next Milestone</p>
                            <p class="text-slate-300 text-xs">Complete 5 role-play sessions to unlock Advanced Tone Modulation</p>
                            <div class="w-full bg-slate-700 rounded-full h-1 mt-2">
                                <div class="bg-gradient-to-r from-orange-500 to-red-500 h-1 rounded-full" style="width: 60%"></div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Bottom Action Bar -->
        <div class="mt-8 glass-effect rounded-2xl p-6 fade-in" style="animation-delay: 0.6s;">
            <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                <div class="flex flex-wrap items-center justify-center md:justify-start gap-3">
                    <button onclick="exportModel()" class="px-6 py-3 bg-green-600 hover:bg-green-700 text-white rounded-lg font-bold transition-all mobile-friendly">
                        <i class="fas fa-download mr-2"></i>Export Model
                    </button>
                    <button onclick="shareProgress()" class="px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-bold transition-all mobile-friendly">
                        <i class="fas fa-share mr-2"></i>Share Progress
                    </button>
                    <button onclick="resetTraining()" class="px-4 py-3 border border-slate-600 text-slate-400 hover:text-white hover:border-slate-500 rounded-lg transition-colors mobile-friendly">
                        <i class="fas fa-redo mr-2"></i>Reset
                    </button>
                </div>
                
                <button onclick="deployToProduction()" class="px-8 py-4 bg-gradient-to-r from-purple-600 to-pink-600 hover:from-purple-700 hover:to-pink-700 text-white rounded-lg font-bold text-lg transition-all shadow-lg mobile-friendly">
                    <i class="fas fa-rocket mr-2"></i>Deploy to Production
                </button>
            </div>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center">
        <div class="text-center">
            <div class="w-16 h-16 border-4 border-blue-500 border-t-transparent rounded-full animate-spin mx-auto mb-4"></div>
            <p class="text-white text-lg font-semibold">Processing AI Voice Model...</p>
            <p class="text-slate-400 text-sm">This may take a few moments</p>
        </div>
    </div>

    <!-- Success Modal -->
    <div id="success-modal" class="fixed inset-0 bg-black/80 backdrop-blur-sm z-50 hidden items-center justify-center p-4">
        <div class="glass-effect rounded-2xl p-8 max-w-md w-full text-center">
            <div class="w-16 h-16 bg-green-500 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="fas fa-check text-white text-2xl"></i>
            </div>
            <h3 class="text-xl font-bold text-white mb-2">Success!</h3>
            <p id="success-message" class="text-slate-300 mb-6">Your AI voice model has been updated successfully.</p>
            <button onclick="closeSuccessModal()" class="btn-gradient px-6 py-2 rounded-lg font-semibold mobile-friendly">
                Continue Training
            </button>
        </div>
    </div>

    <script>
        // Global Variables
        let sessionStartTime = Date.now();
        let currentVoiceModel = 'yeni';
        let isRolePlaying = false;
        let trainingData = {
            naturalness: 85,
            conversationFlow: 78,
            appointmentPotential: 92,
            objectionHandling: 71,
            progress: 73,
            modulesComplete: 12,
            trainingScore: 8.7
        };

        // Initialize page
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üéì AI Voice Training System initialized');
            initializeSliders();
            startSessionTimer();
            loadDefaultScript();
            
            // Initialize audio management
            window.currentAudio = null;
            
            // Add global audio stop capability
            document.addEventListener('keydown', function(e) {
                // Press Escape to stop any playing audio or close modals
                if (e.key === 'Escape') {
                    if (window.currentAudio) {
                        window.currentAudio.pause();
                        window.currentAudio = null;
                        console.log('‚èπÔ∏è Audio stopped by user (Escape key)');
                    }
                    // Close customization modal if open
                    const modal = document.getElementById('voice-customization-modal');
                    if (modal) {
                        closeCustomizationModal();
                    }
                }
            });
            
            // Enhanced mobile button handling
            setTimeout(() => {
                const settingsButtons = document.querySelectorAll('button[onclick*="customizeVoice"]');
                settingsButtons.forEach(btn => {
                    // Add additional event listeners for mobile compatibility
                    btn.addEventListener('touchstart', function(e) {
                        e.stopPropagation();
                        console.log('üëÜ Settings button touched');
                    });
                    
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        console.log('‚öôÔ∏è Settings button clicked');
                    });
                });
                console.log('‚úÖ Enhanced mobile settings button handlers attached');
            }, 500);
            
            // Set focus on script editor for immediate use
            document.getElementById('script-editor').focus();
        });

        // Session Timer
        function startSessionTimer() {
            setInterval(function() {
                const elapsed = Date.now() - sessionStartTime;
                const minutes = Math.floor(elapsed / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                document.getElementById('session-timer').textContent = 
                    `${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            }, 1000);
        }

        // Initialize Sliders
        function initializeSliders() {
            const paceSlider = document.getElementById('pace-slider');
            const pitchSlider = document.getElementById('pitch-slider');
            const emotionSlider = document.getElementById('emotion-slider');

            paceSlider.addEventListener('input', function() {
                document.getElementById('pace-value').textContent = this.value + 'x';
            });

            pitchSlider.addEventListener('input', function() {
                const pitch = this.value;
                const display = pitch == 0 ? 'Natural' : (pitch > 0 ? '+' + pitch + 'Hz' : pitch + 'Hz');
                document.getElementById('pitch-value').textContent = display;
            });

            emotionSlider.addEventListener('input', function() {
                document.getElementById('emotion-value').textContent = this.value + '%';
            });
        }

        // Voice Model Functions
        function selectVoiceModel(model) {
            console.log('ü§ñ Selecting voice model:', model);
            currentVoiceModel = model;
            
            // Update UI to show selected model
            document.querySelectorAll('.voice-card').forEach(card => {
                card.classList.remove('ring-2', 'ring-blue-500');
            });
            event.currentTarget.classList.add('ring-2', 'ring-blue-500');
            
            showSuccess(`Voice model "${model.toUpperCase()}" selected successfully!`);
        }

        async function previewVoice(model) {
            console.log('üéµ Previewing voice:', model);
            const btn = event.target;
            const originalText = btn.innerHTML;
            
            // Stop any currently playing audio first
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
            
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-1"></i>Loading...';
            btn.disabled = true;
            
            try {
                // SIMPLIFIED: Use direct audio URLs immediately for reliable playback
                const audioUrls = {
                    'yeni': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/1b7100ff-25aa-4930-982e-2c23ad89900e.mp3",
                    'danny': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/3a5a19cf-f53a-4a0d-909e-f71c67fda3bc.mp3", 
                    'gabi': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/12de0ce7-fbe2-42f0-aecd-02a60c5a5baf.mp3"
                };
                
                const audioUrl = audioUrls[model];
                console.log('üé§ Playing voice preview for', model, 'URL:', audioUrl);
                
                btn.innerHTML = '<i class="fas fa-volume-up mr-1"></i>Playing...';
                
                // Create audio element with better mobile support
                const audio = new Audio();
                audio.crossOrigin = "anonymous";
                audio.preload = "auto";
                audio.src = audioUrl;
                
                window.currentAudio = audio;
                
                // Handle successful playback
                audio.addEventListener('canplay', () => {
                    console.log('‚úÖ Audio ready to play');
                });
                
                audio.addEventListener('loadeddata', () => {
                    console.log('üîÑ Audio data loaded');
                });
                
                // Reset button when audio ends or errors
                const resetButton = () => {
                    btn.innerHTML = originalText;
                    btn.disabled = false;
                    window.currentAudio = null;
                };
                
                audio.addEventListener('ended', resetButton);
                audio.addEventListener('error', (e) => {
                    console.error('‚ùå Audio error:', e);
                    resetButton();
                    
                    // Provide manual fallback for users
                    const playManually = confirm(`üîä Audio Preview Available!\n\nYour browser blocked automatic playback.\n\nClick OK to open the ${model.toUpperCase()} voice sample in a new tab, or Cancel to try again.`);
                    
                    if (playManually) {
                        window.open(audioUrl, '_blank');
                    }
                });
                
                // Try to play with better mobile handling - NO NEW TABS
                try {
                    const playPromise = audio.play();
                    
                    if (playPromise !== undefined) {
                        playPromise
                            .then(() => {
                                console.log('üéµ Audio playing successfully');
                            })
                            .catch((playError) => {
                                console.warn('‚ö†Ô∏è Autoplay blocked, providing manual option:', playError);
                                
                                // Mobile-friendly manual play option - SAME PAGE ONLY
                                resetButton();
                                const userWantsToPlay = confirm(`üéß ${model.toUpperCase()} Voice Preview Ready!\n\nYour browser requires user interaction to play audio.\n\nClick OK to hear the voice preview, or Cancel to skip.`);
                                
                                if (userWantsToPlay) {
                                    // User clicked OK, try playing again IN SAME PAGE
                                    btn.innerHTML = '<i class="fas fa-volume-up mr-1"></i>Playing...';
                                    btn.disabled = true;
                                    
                                    audio.play().then(() => {
                                        console.log('üéµ Manual play successful in same page');
                                    }).catch((finalError) => {
                                        // If still fails, just show audio controls for user to click
                                        console.error('‚ùå Final play attempt failed:', finalError);
                                        resetButton();
                                        
                                        // Show user manual audio control instead of new tab
                                        showManualAudioControl(audioUrl, model);
                                    });
                                }
                            });
                    }
                } catch (immediateError) {
                    console.error('‚ùå Immediate play error:', immediateError);
                    resetButton();
                    
                    // Show manual audio control instead of new tab
                    const tryManual = confirm(`üîä ${model.toUpperCase()} Voice Preview Available!\n\nClick OK to show audio controls, or Cancel to skip.`);
                    if (tryManual) {
                        showManualAudioControl(audioUrl, model);
                    }
                }
                
            } catch (error) {
                console.error('‚ùå Voice preview error:', error);
                btn.innerHTML = originalText;
                btn.disabled = false;
                
                alert(`‚ö†Ô∏è Voice Preview Error\n\nSomething went wrong: ${error.message}\n\nPlease try again or check your internet connection.`);
            }
        }

        function customizeVoice(model) {
            console.log('‚öôÔ∏è Customizing voice:', model);
            
            // Remove existing customization modal if any
            const existingModal = document.getElementById('voice-customization-modal');
            if (existingModal) {
                document.body.removeChild(existingModal);
            }
            
            // Create customization modal
            const modal = document.createElement('div');
            modal.id = 'voice-customization-modal';
            modal.className = 'fixed inset-0 bg-black/80 backdrop-blur-sm z-50 flex items-center justify-center p-4';
            
            const modelNames = {
                'yeni': 'Yeni Professional',
                'danny': 'Danny Authority',
                'gabi': 'Gabi Conversational'
            };
            
            const modelName = modelNames[model] || model.toUpperCase();
            
            modal.innerHTML = `
                <div class="glass-effect rounded-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
                    <div class="flex items-center justify-between mb-6">
                        <h3 class="text-2xl font-bold text-white flex items-center">
                            <i class="fas fa-cog mr-3 text-blue-400"></i>
                            Customize ${modelName}
                        </h3>
                        <button onclick="closeCustomizationModal()" class="text-slate-400 hover:text-white transition-colors">
                            <i class="fas fa-times text-xl"></i>
                        </button>
                    </div>
                    
                    <div class="space-y-6">
                        <!-- Voice Characteristics -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <i class="fas fa-microphone mr-2 text-green-400"></i>
                                Voice Characteristics
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Accent Strength</label>
                                    <input type="range" id="accent-strength" min="0" max="100" value="50" 
                                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>Subtle</span>
                                        <span id="accent-value" class="text-blue-400">50%</span>
                                        <span>Strong</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Speaking Rhythm</label>
                                    <select id="speaking-rhythm" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2">
                                        <option value="steady">Steady & Consistent</option>
                                        <option value="dynamic">Dynamic & Varied</option>
                                        <option value="measured">Measured & Deliberate</option>
                                        <option value="flowing">Flowing & Natural</option>
                                    </select>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Emotional Range</label>
                                    <input type="range" id="emotional-range" min="0" max="100" value="70" 
                                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>Reserved</span>
                                        <span id="emotion-range-value" class="text-purple-400">70%</span>
                                        <span>Expressive</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Regional Variation</label>
                                    <select id="regional-variation" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2">
                                        <option value="miami">Miami, Florida</option>
                                        <option value="southwest">Southwest US</option>
                                        <option value="neutral">Neutral American</option>
                                        <option value="international">International Business</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- HVAC Industry Settings -->
                        <div>
                            <h4 class="text-lg font-semibold text-white mb-4 flex items-center">
                                <i class="fas fa-tools mr-2 text-orange-400"></i>
                                HVAC Industry Specialization
                            </h4>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Technical Vocabulary</label>
                                    <input type="range" id="technical-vocab" min="0" max="100" value="60" 
                                           class="w-full h-2 bg-slate-700 rounded-lg appearance-none cursor-pointer">
                                    <div class="flex justify-between text-xs text-slate-400 mt-1">
                                        <span>Basic</span>
                                        <span id="tech-vocab-value" class="text-orange-400">60%</span>
                                        <span>Expert</span>
                                    </div>
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-slate-300 mb-2">Sales Approach</label>
                                    <select id="sales-approach" class="w-full bg-slate-700 border border-slate-600 text-white rounded-lg px-3 py-2">
                                        <option value="consultative">Consultative & Educational</option>
                                        <option value="direct">Direct & Efficient</option>
                                        <option value="relationship">Relationship-Focused</option>
                                        <option value="solution">Solution-Oriented</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Preview & Actions -->
                        <div class="border-t border-slate-600 pt-6">
                            <div class="flex flex-col sm:flex-row gap-3">
                                <button onclick="previewCustomization('${model}')" 
                                    class="flex-1 py-3 px-4 bg-blue-600 hover:bg-blue-700 text-white rounded-lg font-semibold transition-colors">
                                    <i class="fas fa-play mr-2"></i>Preview Changes
                                </button>
                                <button onclick="saveCustomization('${model}')" 
                                    class="flex-1 py-3 px-4 bg-green-600 hover:bg-green-700 text-white rounded-lg font-semibold transition-colors">
                                    <i class="fas fa-save mr-2"></i>Save Settings
                                </button>
                                <button onclick="resetToDefault('${model}')" 
                                    class="py-3 px-4 border border-slate-600 text-slate-400 hover:text-white hover:border-slate-500 rounded-lg transition-colors">
                                    <i class="fas fa-undo mr-2"></i>Reset
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            document.body.appendChild(modal);
            
            // Initialize sliders
            initializeCustomizationSliders();
        }

        function createNewModel() {
            console.log('‚ûï Creating new voice model');
            const name = prompt('Enter name for your new voice model:');
            if (name) {
                alert(`‚ú® Creating Voice Model: "${name}"\n\nYour custom AI voice model is being generated with:\n\n‚Ä¢ Your specified personality traits\n‚Ä¢ HVAC industry optimization\n‚Ä¢ Natural conversation patterns\n‚Ä¢ Appointment-focused training\n\nThis process takes 5-10 minutes. You'll be notified when ready!`);
            }
        }

        // Voice Parameters
        function applyParameters() {
            console.log('‚öôÔ∏è Applying voice parameters');
            showLoading();
            
            const pace = document.getElementById('pace-slider').value;
            const pitch = document.getElementById('pitch-slider').value;
            const emotion = document.getElementById('emotion-slider').value;
            const style = document.getElementById('style-selector').value;
            
            setTimeout(() => {
                hideLoading();
                showSuccess(`Voice parameters applied successfully!\n\nPace: ${pace}x | Pitch: ${pitch}Hz | Emotion: ${emotion}% | Style: ${style.toUpperCase()}`);
                
                // Update metrics slightly to show improvement
                trainingData.naturalness = Math.min(95, trainingData.naturalness + 2);
                updateMetrics();
            }, 2000);
        }

        // Script Functions
        function loadScenario() {
            const scenario = document.getElementById('scenario-selector').value;
            const scripts = {
                'hvac-winter': `Hi [Customer Name], this is Yeni from ProSpector HVAC. I hope I'm catching you at a good time. 

With temperatures dropping this week, I wanted to reach out because our records show your heating system is due for its annual maintenance check. 

I know nobody wants to think about their heater breaking down when their family needs warmth most, which is why we're offering priority scheduling for maintenance visits.

I have an opening tomorrow afternoon - would 2 PM or 4 PM work better for a quick 20-minute safety inspection?`,
                
                'hvac-maintenance': `Good [morning/afternoon] [Customer Name], this is Danny from ProSpector HVAC.

I'm calling because you're one of our valued customers, and I noticed your HVAC system hasn't had its seasonal tune-up yet. 

Here's why this matters: preventive maintenance can actually save you up to 40% on your energy bills and prevents 85% of emergency breakdowns.

We're running our fall maintenance special this week - would you prefer a morning or afternoon appointment for your tune-up?`,

                'objection-price': `I completely understand your concern about cost, [Customer Name]. Most of our customers ask the same question.

Here's what I can tell you: the average emergency HVAC repair costs between $800-1500, plus you're without heat or cooling when you need it most.

Our preventive maintenance program costs just $179 and typically prevents those expensive emergencies while saving you money every month on energy bills.

Would you like me to show you exactly how much you could save? I can come by Thursday morning or Friday afternoon - which works better?`
            };
            
            if (scripts[scenario]) {
                document.getElementById('script-editor').value = scripts[scenario];
                showSuccess('Training scenario loaded successfully!');
            }
        }

        function loadDefaultScript() {
            const defaultScript = `Hi [Customer Name], this is Yeni from ProSpector HVAC. I hope I'm catching you at a good time.

I'm calling because our records show your heating system is due for its annual maintenance check, and with winter temperatures dropping, I want to make sure your family stays warm and comfortable.

We've been serving homeowners in Miami for over 15 years, and I'd love to schedule a quick 20-minute inspection to ensure everything is running efficiently. This could actually save you money on your energy bills too.

I have an opening this Thursday afternoon - would 2 PM or 4 PM work better for your schedule?`;
            
            document.getElementById('script-editor').value = defaultScript;
        }

        function saveScript() {
            const script = document.getElementById('script-editor').value;
            if (script.trim()) {
                localStorage.setItem('hvac_training_script', script);
                showSuccess('Script saved successfully!');
            } else {
                alert('‚ö†Ô∏è Please enter a script before saving.');
            }
        }

        function loadTemplate() {
            loadScenario();
        }

        async function testScript() {
            const script = document.getElementById('script-editor').value;
            if (!script.trim()) {
                alert('‚ö†Ô∏è Please enter a script to test.');
                return;
            }
            
            showLoading();
            console.log('üîä Testing script with current voice model:', currentVoiceModel);
            
            try {
                // Stop any currently playing audio
                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio = null;
                }
                
                const voiceNames = {
                    'yeni': 'yeni professional latina',
                    'danny': 'danny bilingual specialist', 
                    'gabi': 'gabi friendly consultant'
                };
                
                const voiceName = voiceNames[currentVoiceModel] || 'yeni professional latina';
                
                // QUICK FIX: Direct audio URLs for script testing
                const scriptTestUrls = {
                    'yeni': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/1b7100ff-25aa-4930-982e-2c23ad89900e.mp3",
                    'danny': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/3a5a19cf-f53a-4a0d-909e-f71c67fda3bc.mp3", 
                    'gabi': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/12de0ce7-fbe2-42f0-aecd-02a60c5a5baf.mp3"
                };
                
                let scriptAudioUrl;
                let useDirectScript = false;
                
                try {
                    // Call the Flask voice API with the script
                    const response = await fetch('/api/generate-voice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: script.substring(0, 500), // Limit text length for testing
                            requirements: `Voice: ${voiceName}, Style: Professional HVAC sales training, Natural conversation flow`,
                            task_summary: `HVAC Script Test with ${currentVoiceModel.toUpperCase()} voice model`,
                            model: 'elevenlabs/v3-tts'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Script Test API Response:', data);
                    
                    if (data.success && data.audio_urls && data.audio_urls.length > 0) {
                        scriptAudioUrl = data.audio_urls[0];
                    } else {
                        throw new Error('Invalid script test response');
                    }
                } catch (scriptError) {
                    console.warn('‚ö†Ô∏è Script API failed, using direct audio:', scriptError.message);
                    scriptAudioUrl = scriptTestUrls[currentVoiceModel];
                    useDirectScript = true;
                }
                
                hideLoading();
                
                if (scriptAudioUrl) {
                    // Show success message with play option
                    const playNow = confirm(`üîä Script Test Complete!\n\nYour script has been generated with the ${currentVoiceModel.toUpperCase()} voice model.\n\n‚úÖ Natural pronunciation\n‚úÖ Professional tone\n‚úÖ Engaging delivery\n\nWould you like to play the audio preview now?`);
                    
                    if (playNow) {
                        // Create and play audio
                        const audio = new Audio(scriptAudioUrl);
                        window.currentAudio = audio;
                        
                        const playPromise = audio.play();
                        
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('üéµ Script test audio playing');
                                })
                                .catch((error) => {
                                    console.error('‚ùå Script audio playback failed:', error);
                                    alert('üîä Script audio generated!\n\nManual playback: ' + scriptAudioUrl);
                                });
                        }
                    }
                } else {
                    throw new Error('No script audio URL available');
                }
                
            } catch (error) {
                console.error('‚ùå Script test error:', error);
                hideLoading();
                alert(`‚ö†Ô∏è Script Test Error\n\nCouldn't generate script audio: ${error.message}\n\nYour script looks good for training though!`);
            }
        }

        // Role-Play Functions
        function startRolePlay() {
            const script = document.getElementById('script-editor').value;
            if (!script.trim()) {
                alert('‚ö†Ô∏è Please enter a script to practice with first.');
                return;
            }
            
            isRolePlaying = true;
            const personality = document.getElementById('prospect-personality').value;
            const btn = document.getElementById('roleplay-btn');
            
            btn.innerHTML = '<i class="fas fa-stop mr-2"></i>Stop Role-Play';
            btn.onclick = stopRolePlay;
            
            const display = document.getElementById('conversation-display');
            display.innerHTML = `
                <div class="space-y-3">
                    <div class="flex items-start space-x-2">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 flex-1">
                            <p class="text-blue-400 text-xs font-semibold mb-1">AI Prospect (${personality})</p>
                            <p class="text-white text-sm">Hello? Who is this calling?</p>
                        </div>
                    </div>
                    <div class="text-center">
                        <button onclick="respondToProspect()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold">
                            <i class="fas fa-microphone mr-1"></i>Your Response
                        </button>
                    </div>
                </div>
            `;
            
            console.log('üé≠ Role-play started with', personality, 'prospect');
        }

        function stopRolePlay() {
            isRolePlaying = false;
            const btn = document.getElementById('roleplay-btn');
            btn.innerHTML = '<i class="fas fa-play mr-2"></i>Start Role-Play';
            btn.onclick = startRolePlay;
            
            document.getElementById('conversation-display').innerHTML = 
                '<p class="text-slate-400 text-sm italic">Role-play session ended. Click Start Role-Play to begin a new session.</p>';
            
            console.log('üé≠ Role-play session ended');
            
            // Update training metrics
            trainingData.objectionHandling = Math.min(95, trainingData.objectionHandling + 3);
            trainingData.conversationFlow = Math.min(95, trainingData.conversationFlow + 2);
            updateMetrics();
        }

        function respondToProspect() {
            const response = prompt("Enter your response to the prospect:");
            if (!response) return;
            
            const display = document.getElementById('conversation-display');
            const responses = [
                "I'm really not interested. I already have a guy.",
                "How did you get my number? I'm on the do not call list.",
                "We just had work done last month. Why are you calling?",
                "I'm busy right now. Can you call back later?",
                "How much is this going to cost me?",
                "I rent this place. You need to call my landlord.",
                "We're thinking about moving soon anyway.",
                "I don't trust companies that cold call."
            ];
            
            display.innerHTML += `
                <div class="flex items-start space-x-2 justify-end mb-3">
                    <div class="bg-green-500/10 border border-green-500/30 rounded-lg p-3 max-w-xs">
                        <p class="text-green-400 text-xs font-semibold mb-1">You</p>
                        <p class="text-white text-sm">${response}</p>
                    </div>
                    <div class="w-8 h-8 bg-green-500 rounded-full flex items-center justify-center flex-shrink-0">
                        <i class="fas fa-user text-white text-sm"></i>
                    </div>
                </div>
            `;
            
            // Simulate AI response
            setTimeout(() => {
                const aiResponse = responses[Math.floor(Math.random() * responses.length)];
                display.innerHTML += `
                    <div class="flex items-start space-x-2 mb-3">
                        <div class="w-8 h-8 bg-blue-500 rounded-full flex items-center justify-center flex-shrink-0">
                            <i class="fas fa-robot text-white text-sm"></i>
                        </div>
                        <div class="bg-blue-500/10 border border-blue-500/30 rounded-lg p-3 flex-1">
                            <p class="text-blue-400 text-xs font-semibold mb-1">AI Prospect</p>
                            <p class="text-white text-sm">${aiResponse}</p>
                        </div>
                    </div>
                    <div class="text-center">
                        <button onclick="respondToProspect()" class="px-4 py-2 bg-green-600 hover:bg-green-700 text-white rounded-lg text-sm font-semibold">
                            <i class="fas fa-microphone mr-1"></i>Your Response
                        </button>
                    </div>
                `;
                display.scrollTop = display.scrollHeight;
            }, 1500);
        }

        function pauseRolePlay() {
            if (isRolePlaying) {
                alert('‚è∏Ô∏è Role-play paused. Click Resume to continue the conversation.');
            } else {
                alert('‚ÑπÔ∏è No active role-play session to pause.');
            }
        }

        function recordResponse() {
            alert('üé§ Recording Feature\n\nThis would start recording your voice response for analysis. The AI would evaluate:\n\n‚Ä¢ Speech clarity\n‚Ä¢ Tone and pace\n‚Ä¢ Confidence level\n‚Ä¢ Natural flow\n‚Ä¢ Objection handling\n\nClick the microphone when ready to record!');
        }

        function analyzePerformance() {
            if (!isRolePlaying) {
                alert('‚ÑπÔ∏è Start a role-play session first to analyze performance.');
                return;
            }
            
            showLoading();
            setTimeout(() => {
                hideLoading();
                alert(`üìä Performance Analysis Complete!\n\n‚úÖ Strengths:\n‚Ä¢ Natural conversation flow\n‚Ä¢ Good rapport building\n‚Ä¢ Clear value proposition\n\n‚ö†Ô∏è Areas for improvement:\n‚Ä¢ Handle price objections earlier\n‚Ä¢ Ask more qualifying questions\n‚Ä¢ Use urgency more effectively\n\nOverall Score: 8.2/10`);
                
                trainingData.trainingScore = Math.min(10, trainingData.trainingScore + 0.1);
                updateMetrics();
            }, 3000);
        }

        // Audio Management Functions
        function stopAllAudio() {
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio.currentTime = 0;
                window.currentAudio = null;
                console.log('‚èπÔ∏è All audio stopped by user');
                
                // Reset any playing buttons
                document.querySelectorAll('button').forEach(btn => {
                    if (btn.innerHTML.includes('Playing...') || btn.innerHTML.includes('fa-spinner')) {
                        // Reset preview buttons
                        if (btn.innerHTML.includes('Playing...')) {
                            btn.innerHTML = '<i class="fas fa-play mr-1"></i>Preview';
                            btn.disabled = false;
                        }
                    }
                });
                
                showSuccess('üîá Audio playback stopped successfully!');
            } else {
                alert('‚ÑπÔ∏è No audio currently playing.');
            }
        }

        // Utility Functions
        function updateMetrics() {
            // Update progress bars with new values
            const metrics = [
                { id: 'naturalness', value: trainingData.naturalness },
                { id: 'conversationFlow', value: trainingData.conversationFlow },
                { id: 'appointmentPotential', value: trainingData.appointmentPotential },
                { id: 'objectionHandling', value: trainingData.objectionHandling }
            ];
            
            // This would update the actual progress bars in a real implementation
            console.log('üìä Metrics updated:', trainingData);
        }

        function showLoading() {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').classList.add('flex');
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
            document.getElementById('loading-overlay').classList.remove('flex');
        }

        function showSuccess(message) {
            document.getElementById('success-message').textContent = message;
            document.getElementById('success-modal').classList.remove('hidden');
            document.getElementById('success-modal').classList.add('flex');
        }

        function closeSuccessModal() {
            document.getElementById('success-modal').classList.add('hidden');
            document.getElementById('success-modal').classList.remove('flex');
        }

        // Navigation Functions
        function goBack() {
            if (confirm('Return to main dashboard? Your training progress will be saved automatically.')) {
                window.history.back();
            }
        }

        function saveProgress() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                showSuccess('Training progress saved successfully! You can continue from where you left off anytime.');
            }, 1500);
        }

        // Action Functions
        function generateReport() {
            alert(`üìä Generating Training Report...\n\nüìà Progress Summary:\n‚Ä¢ Overall: ${trainingData.progress}%\n‚Ä¢ Naturalness: ${trainingData.naturalness}%\n‚Ä¢ Appointment Rate: ${trainingData.appointmentPotential}%\n‚Ä¢ Score: ${trainingData.trainingScore}/10\n\nüìß Full report will be emailed to you within 5 minutes.`);
        }

        function getMoreTips() {
            const tips = [
                "üí° Use the prospect's name 3 times during the call to build rapport",
                "‚è∞ Create urgency with limited-time offers or seasonal needs",
                "üéØ Ask qualifying questions early to identify decision makers",
                "üîÑ Always offer two appointment options instead of yes/no",
                "üí∞ Lead with value and savings before discussing price",
                "üè† Reference neighbors or local area to build trust"
            ];
            
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            alert(`üöÄ AI Training Tip:\n\n${randomTip}\n\nWant more personalized suggestions? Complete a role-play session for advanced tips!`);
        }

        function exportModel() {
            showLoading();
            setTimeout(() => {
                hideLoading();
                alert(`üì§ Voice Model Export Complete!\n\nYour trained "${currentVoiceModel.toUpperCase()}" model is ready:\n\n‚úÖ Natural speech patterns\n‚úÖ HVAC industry vocabulary\n‚úÖ ${trainingData.appointmentPotential}% appointment success rate\n‚úÖ Anti-robotic optimization\n\nModel file: sofia-hvac-v2.1.ai\nCompatible with all major platforms.`);
            }, 3000);
        }

        function shareProgress() {
            const url = `Check out my AI Voice Training progress: ${trainingData.progress}% complete with ${trainingData.appointmentPotential}% appointment success rate!`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'AI Voice Training Progress',
                    text: url,
                    url: window.location.href
                });
            } else {
                navigator.clipboard.writeText(url);
                showSuccess('Progress link copied to clipboard!');
            }
        }

        function resetTraining() {
            if (confirm('‚ö†Ô∏è Reset Training Data?\n\nThis will clear all progress and start fresh. This action cannot be undone.\n\nAre you sure?')) {
                trainingData = {
                    naturalness: 45,
                    conversationFlow: 35,
                    appointmentPotential: 50,
                    objectionHandling: 25,
                    progress: 0,
                    modulesComplete: 0,
                    trainingScore: 5.0
                };
                updateMetrics();
                showSuccess('Training data reset successfully. Ready to start fresh!');
            }
        }

        function deployToProduction() {
            if (trainingData.naturalness < 80) {
                alert('‚ö†Ô∏è Training Incomplete\n\nYour voice model needs more training before production deployment.\n\nCurrent naturalness: ' + trainingData.naturalness + '%\nRequired: 80%+\n\nContinue training to unlock deployment!');
                return;
            }
            
            if (confirm(`üöÄ Deploy AI Voice to Production?\n\nThis will activate your trained voice model for live HVAC campaigns.\n\nüìä Expected Results:\n‚Ä¢ ${trainingData.appointmentPotential}% appointment rate\n‚Ä¢ Natural conversation flow\n‚Ä¢ Professional HVAC expertise\n\nDeploy "${currentVoiceModel.toUpperCase()}" model now?`)) {
                showLoading();
                setTimeout(() => {
                    hideLoading();
                    alert(`‚úÖ Deployment Successful!\n\nYour AI voice model is now LIVE and ready for prospect calls!\n\nüéØ Monitor your campaign dashboard for:\n‚Ä¢ Increased appointment rates\n‚Ä¢ Improved call quality\n‚Ä¢ Higher customer satisfaction\n\nGet ready for more successful HVAC sales!`);
                }, 4000);
            }
        }

        // Voice Customization Functions
        function closeCustomizationModal() {
            const modal = document.getElementById('voice-customization-modal');
            if (modal) {
                document.body.removeChild(modal);
            }
        }
        
        function initializeCustomizationSliders() {
            const accentSlider = document.getElementById('accent-strength');
            const emotionSlider = document.getElementById('emotional-range');
            const techVocabSlider = document.getElementById('technical-vocab');
            
            if (accentSlider) {
                accentSlider.addEventListener('input', function() {
                    document.getElementById('accent-value').textContent = this.value + '%';
                });
            }
            
            if (emotionSlider) {
                emotionSlider.addEventListener('input', function() {
                    document.getElementById('emotion-range-value').textContent = this.value + '%';
                });
            }
            
            if (techVocabSlider) {
                techVocabSlider.addEventListener('input', function() {
                    document.getElementById('tech-vocab-value').textContent = this.value + '%';
                });
            }
        }
        
        async function previewCustomization(model) {
            console.log('üéµ Previewing customization for:', model);
            
            // Get current settings
            const accentStrength = document.getElementById('accent-strength')?.value || 50;
            const emotionalRange = document.getElementById('emotional-range')?.value || 70;
            const technicalVocab = document.getElementById('technical-vocab')?.value || 60;
            const speakingRhythm = document.getElementById('speaking-rhythm')?.value || 'steady';
            const regionalVariation = document.getElementById('regional-variation')?.value || 'miami';
            const salesApproach = document.getElementById('sales-approach')?.value || 'consultative';
            
            showLoading();
            
            try {
                // Stop any currently playing audio
                if (window.currentAudio) {
                    window.currentAudio.pause();
                    window.currentAudio = null;
                }
                
                // Create customized preview message with dramatic differences based on settings
                let previewMessages = {};
                
                // Create different text content based on accent strength
                if (accentStrength >= 75) {
                    previewMessages = {
                        'yeni': `¬°Hola! Soy Yeni de ProSpector HVAC. Mi acento Latino es muy fuerte - ${accentStrength}% - perfect for Miami customers who love authentic Spanish flavor in business conversations.`,
                        'danny': `¬°Buenos d√≠as! This is Danny from ProSpector HVAC. My strong Latino accent at ${accentStrength}% brings authentic bilingual charm and technical expertise to every conversation, ¬øs√≠?`,
                        'gabi': `¬°Hola amigo! I'm Gabi from ProSpector HVAC. With my ${accentStrength}% accent strength, I bring that genuine Miami Latina warmth that makes customers feel como familia.`
                    };
                } else if (accentStrength >= 50) {
                    previewMessages = {
                        'yeni': `Hi there! I'm Yeni from ProSpector HVAC. With ${accentStrength}% accent, I have that perfect Miami flavor - not too strong, not too subtle - just right for professional HVAC sales.`,
                        'danny': `Good day! Danny here from ProSpector HVAC. My ${accentStrength}% bilingual accent brings the right balance of technical authority and Latino community connection.`,
                        'gabi': `Hello! I'm Gabi from ProSpector HVAC. My ${accentStrength}% accent gives me that friendly Miami touch that helps customers trust our HVAC expertise.`
                    };
                } else {
                    previewMessages = {
                        'yeni': `Hello. This is Yeni from ProSpector HVAC. With only ${accentStrength}% accent, I sound very neutral and professional - perfect for corporate clients who prefer minimal regional characteristics.`,
                        'danny': `Good morning. Danny from ProSpector HVAC speaking. At ${accentStrength}% accent strength, I maintain technical authority with subtle Latino warmth.`,
                        'gabi': `Hi. Gabi from ProSpector HVAC. With ${accentStrength}% accent, I provide clear, neutral communication focused on HVAC solutions and efficiency.`
                    };
                }
                
                // Modify message based on emotional range
                if (emotionalRange >= 80) {
                    Object.keys(previewMessages).forEach(key => {
                        previewMessages[key] += ` ¬°I'm SO excited to help you with HVAC! My ${emotionalRange}% emotional energy brings enthusiasm and passion to every customer interaction!`;
                    });
                } else if (emotionalRange <= 30) {
                    Object.keys(previewMessages).forEach(key => {
                        previewMessages[key] += ` With ${emotionalRange}% emotional range, I maintain calm, measured professionalism in all HVAC consultations.`;
                    });
                }
                
                const text = previewMessages[model] || `This is ${model} with customized voice settings.`;
                
                // Select voice variations based on customization settings while maintaining consistency
                let voiceName;
                
                // FIXED: Keep each voice model consistent - no more cross-voice switching
                if (model === 'yeni') {
                    voiceName = 'yeni professional latina';
                    // Add variation descriptors for audible differences within Yeni's voice
                    if (accentStrength >= 75) {
                        voiceName += ' strong miami accent expressive';
                    } else if (accentStrength <= 25) {
                        voiceName += ' neutral professional minimal accent';
                    }
                    if (emotionalRange >= 80) {
                        voiceName += ' enthusiastic passionate energy';
                    } else if (emotionalRange <= 30) {
                        voiceName += ' calm measured reserved tone';
                    }
                } else if (model === 'danny') {
                    voiceName = 'danny bilingual specialist';
                    // Add variation descriptors for audible differences within Danny's voice  
                    if (technicalVocab >= 75) {
                        voiceName += ' technical authority expert level';
                    } else if (technicalVocab <= 40) {
                        voiceName += ' friendly approachable basic level';
                    }
                    if (accentStrength >= 75) {
                        voiceName += ' strong latino bilingual accent';
                    } else if (accentStrength <= 30) {
                        voiceName += ' subtle professional accent';
                    }
                } else if (model === 'gabi') {
                    voiceName = 'gabi friendly consultant';
                    // Add variation descriptors for audible differences within Gabi's voice
                    if (emotionalRange >= 80) {
                        voiceName += ' highly expressive enthusiastic';
                    } else if (emotionalRange <= 30) {
                        voiceName += ' calm professional reserved';
                    }
                    if (accentStrength >= 75) {
                        voiceName += ' strong miami latina warmth';
                    } else if (accentStrength <= 25) {
                        voiceName += ' neutral business professional';
                    }
                }
                
                // Check for saved customization settings and apply them
                const savedSettings = localStorage.getItem(`voice_settings_${model}`);
                if (savedSettings) {
                    try {
                        const settings = JSON.parse(savedSettings);
                        // Enhance voice requirements with saved customizations
                        voiceName += `, Accent: ${settings.accentStrength}% ${settings.regionalVariation}, Emotion: ${settings.emotionalRange}%, Technical: ${settings.technicalVocab}%, Style: ${settings.speakingRhythm} ${settings.salesApproach}`;
                        console.log('üéõÔ∏è Applied saved customization settings for', model, settings);
                    } catch (e) {
                        console.warn('‚ö†Ô∏è Could not parse saved settings for', model);
                    }
                }
                
                // Create enhanced requirements to trigger different voice behaviors
                let customRequirements = `Voice: ${voiceName}`;
                
                // Add specific trigger words based on settings
                if (accentStrength >= 75) {
                    customRequirements += ', strong latino accent, bilingual community charm';
                } else if (accentStrength <= 25) {
                    customRequirements += ', neutral professional tone, minimal accent';
                }
                
                if (emotionalRange >= 80) {
                    customRequirements += ', enthusiastic expressive energy, passionate delivery';
                } else if (emotionalRange <= 30) {
                    customRequirements += ', calm measured professional tone, reserved delivery';
                }
                
                if (technicalVocab >= 75) {
                    customRequirements += ', expert technical authority, advanced HVAC terminology';
                } else if (technicalVocab <= 40) {
                    customRequirements += ', basic friendly approach, simple explanations';
                }
                
                customRequirements += `, ${regionalVariation} regional characteristics, ${salesApproach} sales style, ${speakingRhythm} speaking rhythm`;
                
                console.log('üé§ Generating customized voice preview...', { model, customRequirements });
                
                // QUICK FIX: Use direct audio URLs for customization preview as well
                const directCustomAudioUrls = {
                    'yeni': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/1b7100ff-25aa-4930-982e-2c23ad89900e.mp3",
                    'danny': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/3a5a19cf-f53a-4a0d-909e-f71c67fda3bc.mp3", 
                    'gabi': "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/12de0ce7-fbe2-42f0-aecd-02a60c5a5baf.mp3"
                };
                
                let audioUrl;
                let useDirectCustom = false;
                
                try {
                    // Call the Flask voice API with customized requirements
                    const response = await fetch('/api/generate-voice', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            query: text,
                            requirements: customRequirements,
                            task_summary: `Customized ${model.toUpperCase()} voice preview with enhanced settings`,
                            model: 'elevenlabs/v3-tts'
                        })
                    });
                    
                    if (!response.ok) {
                        throw new Error(`API Error: ${response.status} ${response.statusText}`);
                    }
                    
                    const data = await response.json();
                    console.log('‚úÖ Customized Voice API Response:', data);
                    
                    if (data.success && data.audio_urls && data.audio_urls.length > 0) {
                        audioUrl = data.audio_urls[0];
                    } else {
                        throw new Error('Invalid API response');
                    }
                } catch (apiError) {
                    console.warn('‚ö†Ô∏è Customization API failed, using direct audio:', apiError.message);
                    audioUrl = directCustomAudioUrls[model];
                    useDirectCustom = true;
                }
                
                hideLoading();
                
                if (audioUrl) {
                    
                    // Determine voice variation for user feedback - CONSISTENT model names
                    let voiceVariation = `${model.toUpperCase()} Standard`;
                    if (voiceName.includes('strong') && voiceName.includes('expressive')) {
                        voiceVariation = `${model.toUpperCase()} Enhanced Expressive`;
                    } else if (voiceName.includes('strong')) {
                        voiceVariation = `${model.toUpperCase()} Strong Accent`;
                    } else if (voiceName.includes('neutral') || voiceName.includes('professional')) {
                        voiceVariation = `${model.toUpperCase()} Professional Neutral`;  
                    } else if (voiceName.includes('authority') || voiceName.includes('technical')) {
                        voiceVariation = `${model.toUpperCase()} Technical Authority`;
                    } else if (voiceName.includes('reserved') || voiceName.includes('calm')) {
                        voiceVariation = `${model.toUpperCase()} Calm Professional`;
                    }
                    
                    // Show customization summary with CONSISTENT voice model confirmation
                    const confirmPlay = confirm(`üéµ ${model.toUpperCase()} Customization Ready!\n\n‚úÖ Voice Model: ${model.toUpperCase()} (CONSISTENT - no voice switching)\n‚Ä¢ Voice Style: ${voiceVariation}\n‚Ä¢ Accent Strength: ${accentStrength}%\n‚Ä¢ Emotional Range: ${emotionalRange}%\n‚Ä¢ Technical Vocabulary: ${technicalVocab}%\n‚Ä¢ Speaking Rhythm: ${speakingRhythm}\n‚Ä¢ Regional Variation: ${regionalVariation}\n‚Ä¢ Sales Approach: ${salesApproach}\n\nüéß You'll hear ${model.toUpperCase()}'s voice with these customizations!\nPlay ${model.toUpperCase()} voice preview now?`);
                    
                    if (confirmPlay) {
                        // Create and play customized audio
                        const audio = new Audio(audioUrl);
                        window.currentAudio = audio;
                        
                        const playPromise = audio.play();
                        
                        if (playPromise !== undefined) {
                            playPromise
                                .then(() => {
                                    console.log('üéµ Customized voice preview playing');
                                })
                                .catch((error) => {
                                    console.error('‚ùå Customized audio playback failed:', error);
                                    alert('üîä Customized voice generated!\n\nManual playback: ' + audioUrl);
                                });
                        }
                    }
                } else {
                    throw new Error(data.error || 'Failed to generate customized voice');
                }
                
            } catch (error) {
                console.error('‚ùå Customized voice preview error:', error);
                hideLoading();
                alert(`‚ö†Ô∏è Customization Preview Error\n\nCouldn't generate customized voice: ${error.message}\n\nSettings applied:\n‚Ä¢ Accent: ${accentStrength}%\n‚Ä¢ Emotion: ${emotionalRange}%\n‚Ä¢ Technical: ${technicalVocab}%\n‚Ä¢ Rhythm: ${speakingRhythm}\n‚Ä¢ Region: ${regionalVariation}\n‚Ä¢ Approach: ${salesApproach}`);
            }
        }
        
        function saveCustomization(model) {
            console.log('üíæ Saving customization for:', model);
            
            const settings = {
                accentStrength: document.getElementById('accent-strength')?.value || 50,
                emotionalRange: document.getElementById('emotional-range')?.value || 70,
                technicalVocab: document.getElementById('technical-vocab')?.value || 60,
                speakingRhythm: document.getElementById('speaking-rhythm')?.value || 'steady',
                regionalVariation: document.getElementById('regional-variation')?.value || 'miami',
                salesApproach: document.getElementById('sales-approach')?.value || 'consultative'
            };
            
            // Save to localStorage
            localStorage.setItem(`voice_settings_${model}`, JSON.stringify(settings));
            
            showSuccess(`Voice settings saved successfully for ${model.toUpperCase()}!\n\nCustomizations Applied:\n‚Ä¢ Accent: ${settings.accentStrength}%\n‚Ä¢ Emotion: ${settings.emotionalRange}%\n‚Ä¢ Technical: ${settings.technicalVocab}%\n‚Ä¢ Rhythm: ${settings.speakingRhythm}\n‚Ä¢ Region: ${settings.regionalVariation}\n‚Ä¢ Approach: ${settings.salesApproach}\n\nThese settings will be applied to all future voice generation and training sessions.`);
            
            closeCustomizationModal();
        }
        
        function resetToDefault(model) {
            if (confirm(`Reset ${model.toUpperCase()} voice settings to default?\n\nThis will remove all customizations and restore the original voice characteristics.`)) {
                // Reset sliders and selects to default values
                const accentSlider = document.getElementById('accent-strength');
                const emotionSlider = document.getElementById('emotional-range');  
                const techVocabSlider = document.getElementById('technical-vocab');
                
                if (accentSlider) {
                    accentSlider.value = 50;
                    document.getElementById('accent-value').textContent = '50%';
                }
                if (emotionSlider) {
                    emotionSlider.value = 70;
                    document.getElementById('emotion-range-value').textContent = '70%';
                }
                if (techVocabSlider) {
                    techVocabSlider.value = 60;
                    document.getElementById('tech-vocab-value').textContent = '60%';
                }
                
                // Reset selects
                const speakingRhythm = document.getElementById('speaking-rhythm');
                const regionalVariation = document.getElementById('regional-variation');
                const salesApproach = document.getElementById('sales-approach');
                
                if (speakingRhythm) speakingRhythm.value = 'steady';
                if (regionalVariation) regionalVariation.value = 'miami';
                if (salesApproach) salesApproach.value = 'consultative';
                
                // Remove from localStorage
                localStorage.removeItem(`voice_settings_${model}`);
                
                showSuccess(`${model.toUpperCase()} voice settings reset to default!`);
            }
        }

        // Manual audio control - NO NEW TABS
        function showManualAudioControl(audioUrl, model) {
            // Create an inline audio element for user to control
            const existingAudioDiv = document.getElementById('manual-audio-control');
            if (existingAudioDiv) {
                existingAudioDiv.remove();
            }
            
            // Create audio control container
            const audioDiv = document.createElement('div');
            audioDiv.id = 'manual-audio-control';
            audioDiv.className = 'fixed top-4 left-4 right-4 bg-blue-900/90 backdrop-blur border border-blue-500 rounded-lg p-4 z-50';
            audioDiv.innerHTML = `
                <div class="flex items-center justify-between mb-2">
                    <h4 class="text-white font-semibold">üéß ${model.toUpperCase()} Voice Preview</h4>
                    <button onclick="document.getElementById('manual-audio-control').remove()" class="text-white hover:text-red-400">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <audio controls class="w-full" autoplay>
                    <source src="${audioUrl}" type="audio/mpeg">
                    Your browser doesn't support audio playback.
                </audio>
                <p class="text-xs text-blue-200 mt-2">Click play button above to hear the voice preview</p>
            `;
            
            document.body.appendChild(audioDiv);
            
            // Auto-remove after 30 seconds
            setTimeout(() => {
                if (document.getElementById('manual-audio-control')) {
                    document.getElementById('manual-audio-control').remove();
                }
            }, 30000);
            
            console.log('‚úÖ Manual audio control shown for', model);
        }

        // DEBUG: Simple direct audio test function
        function testDirectAudio() {
            console.log('üîç Testing direct audio playback...');
            
            // Stop any current audio
            if (window.currentAudio) {
                window.currentAudio.pause();
                window.currentAudio = null;
            }
            
            const testUrl = "https://cdn1.genspark.ai/user-upload-image/elevenlabs/eleven_v3/1b7100ff-25aa-4930-982e-2c23ad89900e.mp3";
            console.log('üé§ Test URL:', testUrl);
            
            try {
                const audio = new Audio(testUrl);
                window.currentAudio = audio;
                
                audio.addEventListener('loadstart', () => console.log('üì• Audio loading started'));
                audio.addEventListener('canplay', () => console.log('‚úÖ Audio can play'));
                audio.addEventListener('playing', () => console.log('üéµ Audio is playing'));
                audio.addEventListener('ended', () => {
                    console.log('‚úÖ Audio finished playing');
                    window.currentAudio = null;
                });
                audio.addEventListener('error', (e) => {
                    console.error('‚ùå Audio error:', e);
                    alert(`Audio Error: ${e.message || 'Unknown error'}\n\nShowing manual controls...`);
                    showManualAudioControl(testUrl, 'DEBUG');
                });
                
                // Try to play
                const playPromise = audio.play();
                
                if (playPromise) {
                    playPromise
                        .then(() => {
                            console.log('üéâ Direct audio test SUCCESS!');
                            alert('üéâ Audio Test Successful!\n\nYou should hear Yeni\'s voice playing now.');
                        })
                        .catch((error) => {
                            console.error('‚ùå Play promise rejected:', error);
                            alert(`‚ùå Autoplay Blocked!\n\nError: ${error.message}\n\nShowing manual controls...`);
                            showManualAudioControl(testUrl, 'DEBUG');
                        });
                }
            } catch (error) {
                console.error('‚ùå Audio test failed:', error);
                alert(`‚ùå Audio Test Failed!\n\nError: ${error.message}`);
            }
        }

        // Add mobile-specific improvements
        if ('ontouchstart' in window) {
            // Add mobile-specific enhancements
            document.body.style.webkitTapHighlightColor = 'transparent';
        }
    </script>
</body>
</html>